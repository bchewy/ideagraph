## Codebase Patterns
- Next.js 16 with App Router, src directory, TypeScript
- Tailwind CSS v4 configured via PostCSS (`@tailwindcss/postcss`)
- shadcn/ui initialized with `components.json`, components live in `src/components/ui/`
- Path alias `@/*` maps to `src/*`
- `npm run typecheck` runs `npx tsc --noEmit`
- Geist font loaded via `next/font/google` in root layout
- Drizzle ORM with better-sqlite3: connection in `src/lib/db/index.ts`, schema in `src/lib/db/schema.ts`
- drizzle.config.ts points schema to `./src/lib/db/schema.ts`, migrations output to `./drizzle/`
- SQLite database file at `./sqlite.db` (gitignored), WAL mode enabled
- Use `npx drizzle-kit generate` for migrations, `npx drizzle-kit push` to apply during dev
- Drizzle SQLite schema: `text('snake_case')` for text, `integer('snake_case')` for ints, camelCase for TS
- Server actions in `src/app/actions.ts` with `'use server'` directive for DB mutations
- Client components use `'use client'` directive and call server actions directly
- Next.js 16 dynamic route params are `Promise<{ id: string }>` — must `await params`
- OpenAI Responses API: file inputs use `type: 'input_file'` with `file_id`, NOT `type: 'file'`
- Use `zodTextFormat` from `openai/helpers/zod` + `responses.parse()` for typed Structured Outputs

---

## 2026-02-03 - US-001
- Scaffolded Next.js 16.1.6 project with App Router, TypeScript, Tailwind CSS v4
- Initialized shadcn/ui with Button and Card components
- Updated root layout with IdeaGraph metadata
- Updated home page to use shadcn/ui components
- Files changed: package.json, tsconfig.json, next.config.ts, postcss.config.mjs, eslint.config.mjs, next-env.d.ts, .gitignore, src/app/layout.tsx, src/app/page.tsx, src/app/globals.css, src/lib/utils.ts, src/components/ui/button.tsx, src/components/ui/card.tsx, components.json
- **Learnings for future iterations:**
  - create-next-app refuses to run in a directory with existing files — scaffold in /tmp and copy over
  - shadcn/ui v3.8+ supports Tailwind v4 natively, uses `@theme inline` CSS syntax
  - Turbopack shows a root warning when a parent directory also has a package-lock.json (benign)
---

## 2026-02-03 - US-002
- Installed drizzle-orm, better-sqlite3, drizzle-kit, @types/better-sqlite3
- Created drizzle.config.ts for SQLite dialect with schema at src/lib/db/schema.ts
- Created src/lib/db/index.ts with better-sqlite3 connection (WAL mode)
- Created src/lib/db/schema.ts (empty placeholder for US-003)
- Added *.db to .gitignore
- Files changed: package.json, package-lock.json, drizzle.config.ts, src/lib/db/index.ts, src/lib/db/schema.ts, .gitignore
- **Learnings for future iterations:**
  - Drizzle ORM v0.x uses `drizzle({ client: sqlite })` pattern for better-sqlite3
  - drizzle-kit uses `defineConfig` with `dialect: 'sqlite'` (not `driver`)
  - Enable WAL mode via `sqlite.pragma('journal_mode = WAL')` for better concurrent read performance
---

## 2026-02-03 - US-003
- Defined `projects` table: id (text PK), name (text), createdAt (integer)
- Defined `documents` table: id (text PK), projectId (FK → projects.id), filename, openaiFileId (nullable), status (default 'pending'), sizeBytes, createdAt
- Generated migration via `npx drizzle-kit generate` → drizzle/0000_smooth_daredevil.sql
- Applied migration via `npx drizzle-kit push`
- Files changed: src/lib/db/schema.ts, drizzle/0000_smooth_daredevil.sql, drizzle/meta/
- **Learnings for future iterations:**
  - `npx drizzle-kit generate` creates SQL migration files in the `drizzle/` directory
  - `npx drizzle-kit push` applies schema directly to the database (good for development)
  - Drizzle SQLite uses `text('column_name')` and `integer('column_name')` with snake_case DB names
---

## 2026-02-03 - US-004
- Defined `nodes` table: id, projectId (FK), label, summary, tags (JSON text default '[]'), createdAt
- Defined `edges` table: id, projectId (FK), sourceNodeId (FK → nodes), targetNodeId (FK → nodes), type, confidence (real), createdAt
- Defined `evidenceRefs` table: id, nodeId (FK nullable), edgeId (FK nullable), documentId (FK), excerpt, locator (nullable)
- Defined `jobs` table: id, projectId (FK), type, status (default 'pending'), error (nullable), createdAt, completedAt (nullable)
- Generated migration drizzle/0001_wooden_unus.sql, applied with push
- Files changed: src/lib/db/schema.ts, drizzle/0001_wooden_unus.sql, drizzle/meta/
- **Learnings for future iterations:**
  - Use `real('column')` from drizzle-orm/sqlite-core for floating-point columns (e.g., confidence scores)
  - Tags stored as JSON text with `text('tags').default('[]')` — parse with JSON.parse on read
  - evidenceRefs uses nullable nodeId and edgeId to associate with either entity
---

## 2026-02-03 - US-005
- Installed `openai` package
- Created `src/lib/openai/client.ts` exporting configured OpenAI client using `OPENAI_API_KEY` env var
- Created `.env.local.example` with placeholder API key
- Files changed: package.json, package-lock.json, src/lib/openai/client.ts, .env.local.example
- **Learnings for future iterations:**
  - OpenAI SDK reads `OPENAI_API_KEY` from `process.env` by default, but explicit is clearer
  - `.env*` pattern in .gitignore matches `.env.local.example` — need `!.env.local.example` exception
---

## 2026-02-03 - US-006
- Built projects list page at `/` with server-side data fetching via `getProjects()` action
- Created `CreateProjectDialog` client component with shadcn/ui Dialog + Input
- Server action `createProject` inserts into DB and calls `revalidatePath('/')`
- Added shadcn/ui Dialog and Input components
- Project cards link to `/projects/[id]` with hover state
- Browser verified: empty state, dialog, project creation, navigation all working
- Files changed: src/app/page.tsx, src/app/actions.ts, src/components/CreateProjectDialog.tsx, src/components/ui/dialog.tsx, src/components/ui/input.tsx, package.json, package-lock.json
- **Learnings for future iterations:**
  - Server actions with `'use server'` work for CRUD in Next.js 16 App Router
  - `revalidatePath('/')` + `router.refresh()` needed for server component rerender after mutation
  - shadcn/ui Dialog needs `open`/`onOpenChange` controlled state for programmatic close
---

## 2026-02-03 - US-007
- Created `/projects/[id]` route with workspace layout
- Added `getProject(id)` server action with `eq()` filter, returns 404 via `notFound()` for missing IDs
- Layout: header (back link + project name), left sidebar (w-64, documents), main area (graph canvas placeholder)
- Full-height flex layout with `h-screen`, `overflow-hidden` on content area
- Browser verified: layout renders correctly with all three zones
- Files changed: src/app/projects/[id]/page.tsx, src/app/actions.ts
- **Learnings for future iterations:**
  - Next.js 16 dynamic route params are `Promise<{ id: string }>` — must `await params`
  - `notFound()` from `next/navigation` renders the default 404 page for missing resources
---

## 2026-02-03 - US-008
- Created `UploadDropzone` client component in `src/components/documents/UploadDropzone.tsx`
- Accepts PDF files only, enforces 50MB limit client-side
- Dashed border dropzone with drag-over visual feedback (border-primary + bg tint)
- Shows upload progress text per file, handles multiple files sequentially
- POSTs to `/api/projects/{id}/upload` as multipart FormData (API built in US-009)
- Integrated into workspace sidebar
- Browser verified: dropzone renders with correct styling and instructions
- Files changed: src/components/documents/UploadDropzone.tsx, src/app/projects/[id]/page.tsx
- **Learnings for future iterations:**
  - Native drag-and-drop uses onDragOver/onDragLeave/onDrop — need `e.preventDefault()` on all three
  - Hidden file input + ref pattern for click-to-browse alongside drag-and-drop
---

## 2026-02-03 - US-009
- Created `POST /api/projects/[id]/upload` route at `src/app/api/projects/[id]/upload/route.ts`
- Validates: project exists, file is PDF, file is under 50MB
- Saves files to `uploads/{projectId}/{filename}` directory
- Creates document record with status 'uploaded' in DB
- Returns document ID, filename, sizeBytes, status
- Added `/uploads` to .gitignore
- Files changed: src/app/api/projects/[id]/upload/route.ts, .gitignore
- **Learnings for future iterations:**
  - Next.js API routes use `request.formData()` for multipart uploads, `formData.get('file')` returns `File`
  - `Buffer.from(await file.arrayBuffer())` to convert File to writable Buffer
  - `mkdir(dir, { recursive: true })` ensures upload directory exists
---

## 2026-02-03 - US-010
- Added OpenAI Files API upload after local file save in upload route
- Uses `fs.createReadStream(filePath)` with `openai.files.create({ purpose: 'assistants' })`
- Stores returned `openaiFileId` on document record
- Gracefully handles OpenAI upload failures (logs error, continues with null openaiFileId)
- Files changed: src/app/api/projects/[id]/upload/route.ts
- **Learnings for future iterations:**
  - OpenAI files.create accepts `fs.createReadStream()` for Node.js file uploads
  - Purpose 'assistants' is used for files referenced in Responses API calls
  - Wrap OpenAI calls in try/catch to avoid blocking the upload flow if API is unavailable
---

## 2026-02-03 - US-011
- Created `DocumentList` component showing filename, status badge, and file size
- Created `Sidebar` client component wrapping UploadDropzone + DocumentList with refresh logic
- Added `getDocuments(projectId)` server action
- Created `GET /api/projects/[id]/documents` API route for client-side refresh
- Added shadcn/ui Badge component for status display
- Integrated Sidebar into workspace page with server-fetched initial documents
- Browser verified: empty state shows correctly, dropzone + document list layout works
- Files changed: src/components/documents/DocumentList.tsx, src/components/documents/Sidebar.tsx, src/app/api/projects/[id]/documents/route.ts, src/app/actions.ts, src/app/projects/[id]/page.tsx, src/components/ui/badge.tsx
- **Learnings for future iterations:**
  - Pattern: server component fetches initial data, passes to client component, client refreshes via API
  - Sidebar client component manages document state and passes refresh callback to UploadDropzone
---

## 2026-02-03 - US-012
- Created `POST /api/projects/[id]/extract` route
- Accepts `{ documentIds: string[] }`, validates project exists and documentIds is non-empty
- Creates job record with type 'extraction', status 'pending'
- Returns `{ jobId }` immediately, kicks off async extraction via fire-and-forget
- `runExtraction` updates job status to 'running', calls `extractIdeas`, then updates to 'completed'/'failed'
- Created stub `extractIdeas` in `src/lib/openai/extract.ts` (updates doc status, actual GPT logic in US-013)
- Files changed: src/app/api/projects/[id]/extract/route.ts, src/lib/openai/extract.ts
- **Learnings for future iterations:**
  - Fire-and-forget pattern: call async function without awaiting, wrap in .catch() for error handling
  - Dynamic import `await import('@/lib/openai/extract')` to avoid loading extraction code on every request
  - Job status flow: pending → running → completed/failed
---

## 2026-02-03 - US-013
- Implemented full extraction pipeline in `src/lib/openai/extract.ts`
- Uses `openai.responses.parse()` with `zodTextFormat` for Structured Outputs
- Zod schema: ExtractionResult with ideas array (label, summary, tags[], excerpts[])
- Sends PDF via `input_file` content type referencing the OpenAI file ID
- Extracts up to 30 ideas per document, stores nodes + evidenceRefs in database
- Updates document status: extracting → extracted
- Files changed: src/lib/openai/extract.ts, package.json
- **Learnings for future iterations:**
  - OpenAI Responses API file input uses `type: 'input_file'` with `file_id` (not `type: 'file'`)
  - `zodTextFormat` from `openai/helpers/zod` enables Structured Outputs with Zod schemas
  - `responses.parse()` returns `output_parsed` with the typed result
  - Model 'gpt-4.1' is used for extraction (good balance of speed and quality)
---

## 2026-02-03 - US-014
- Created `GET /api/jobs/[id]` route returning job status, type, error, timestamps
- Returns 404 for unknown job IDs
- Files changed: src/app/api/jobs/[id]/route.ts
---

## 2026-02-03 - US-015
- Added extraction trigger button ("Extract Ideas") to Sidebar, visible when uploaded docs exist
- Polls `GET /api/jobs/{id}` every 2 seconds with `setInterval` + cleanup on unmount
- Shows spinner with status text during extraction (pending/running)
- Shows success/error message on completion/failure
- Refreshes document list on completion, calls `onGraphRefresh` callback
- Browser verified: sidebar renders correctly, extract button hidden when no uploaded docs
- Files changed: src/components/documents/Sidebar.tsx
- **Learnings for future iterations:**
  - Use `useRef` for interval IDs to avoid stale closures in cleanup
  - CSS spinner: `animate-spin rounded-full border-2 border-current border-t-transparent`
  - Sidebar accepts `onGraphRefresh` prop for parent to refresh graph data after extraction
---

## 2026-02-03 - US-016
- Added `embedding` column (text, nullable) to `nodes` table in schema
- Generated migration `drizzle/0002_long_blockbuster.sql`, applied with `drizzle-kit push`
- Created `src/lib/openai/embeddings.ts` with `generateEmbeddings(projectId)` function
- Fetches all nodes for a project, generates embeddings from `label: summary` text
- Calls `openai.embeddings.create` with `text-embedding-3-large` model
- Stores embedding vectors as JSON text in the `embedding` column
- Files changed: src/lib/db/schema.ts, src/lib/openai/embeddings.ts, drizzle/0002_long_blockbuster.sql, drizzle/meta/
- **Learnings for future iterations:**
  - Embeddings stored as JSON-serialized arrays in SQLite text columns (parse with `JSON.parse`)
  - `text-embedding-3-large` returns 3072-dimensional vectors by default
  - OpenAI embeddings API accepts batch input — send all texts in one call for efficiency
---

## 2026-02-03 - US-017
- Created `src/lib/openai/link.ts` with cosine similarity and candidate pair generation
- `cosineSimilarity(a, b)` computes dot product / (norm_a * norm_b) for embedding vectors
- `deduplicateNodes()` removes near-duplicate nodes (similarity >= 0.88) from the database
- `getCandidatePairs(projectId)` fetches nodes with embeddings, deduplicates, then generates all pairs with similarity > 0.4
- Returns sorted pairs (highest similarity first) for downstream GPT classification
- Exports `CandidatePair` interface for use in US-018/US-019
- Files changed: src/lib/openai/link.ts
- **Learnings for future iterations:**
  - Embeddings stored as JSON text in SQLite — parse with `JSON.parse(n.embedding!)` to get `number[]`
  - O(n^2) pairwise comparison is acceptable for MVP node counts (max ~30 per document)
  - Deduplication deletes the duplicate node from DB, keeping the first encountered
---

## 2026-02-03 - US-018
- Implemented `classifyRelationships(projectId, candidatePairs)` in `src/lib/openai/link.ts`
- Zod schema with `EdgeTypeEnum` (supports, contradicts, extends, similar, example_of, depends_on)
- Uses `zodTextFormat` + `responses.parse()` for Structured Outputs (same pattern as extract.ts)
- Batches candidate pairs in groups of 20 to avoid overloading GPT context
- Sends node labels, summaries, and cosine similarity to GPT-4.1 for classification
- Validates GPT-returned edges: checks node IDs against batch, filters confidence < 0.5
- Stores edges in DB and creates evidenceRefs linked to the edge (uses source node's document)
- Files changed: src/lib/openai/link.ts
- **Learnings for future iterations:**
  - GPT may hallucinate node IDs — validate returned sourceId/targetId against the input batch
  - Edge evidenceRefs need a documentId; use the source node's first evidence document as fallback
  - Batch processing prevents token limit issues with large candidate pair sets
---

## 2026-02-03 - US-019
- Created `POST /api/projects/[id]/link` route at `src/app/api/projects/[id]/link/route.ts`
- Creates job record with type 'linking', status 'pending', returns `{ jobId }` immediately
- Fire-and-forget async `runLinking` orchestrates: generateEmbeddings → getCandidatePairs → classifyRelationships
- Updates job status: pending → running → completed/failed
- Uses dynamic imports to avoid loading heavy AI code on every request
- Files changed: src/app/api/projects/[id]/link/route.ts
- **Learnings for future iterations:**
  - Link route follows same fire-and-forget job pattern as extract route
  - Pipeline order matters: embeddings must be generated before candidate pairs (which parse them)
  - The `_request` param is unused but required by Next.js route handler signature
---
